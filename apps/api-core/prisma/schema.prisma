generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleScope {
  HUB
  PORTAL
}

enum UserType {
  HUB
  PORTAL
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum RequestStatus {
  OPEN
  APPROVED
  REJECTED
}

model Tenant {
  id          String        @id
  slug        String        @unique
  name        String
  createdAt   DateTime      @default(now())
  memberships Membership[]
  toolInstalls ToolInstall[]
  invites     Invite[]
  auditLogs   AuditLog[]
  tasks       Task[]
  files       FileItem[]
  requests    RequestItem[]
}

model User {
  id         String      @id
  email      String      @unique
  name       String
  type       UserType
  createdAt  DateTime    @default(now())
  memberships Membership[]
  auditLogs  AuditLog[]  @relation("AuditActor")
  createdRequests RequestItem[] @relation("RequestCreatedBy")
  decidedRequests RequestItem[] @relation("RequestDecidedBy")
  assignedTasks Task[] @relation("TaskAssignee")
}

model Membership {
  id        String   @id
  tenantId  String
  userId    String
  roleKey   String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleKey], references: [key])

  @@unique([tenantId, userId])
}

model Role {
  key         String           @id
  scope       RoleScope
  name        String
  description String?
  permissions RolePermission[]
  memberships Membership[]
  invites     Invite[]
}

model Permission {
  key         String           @id
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleKey       String
  permissionKey String

  role       Role       @relation(fields: [roleKey], references: [key])
  permission Permission @relation(fields: [permissionKey], references: [key])

  @@id([roleKey, permissionKey])
}

model Tool {
  key   String @id
  name  String
  installs ToolInstall[]
}

model ToolInstall {
  id       String  @id
  tenantId String
  toolKey  String
  enabled  Boolean

  tenant Tenant @relation(fields: [tenantId], references: [id])
  tool   Tool   @relation(fields: [toolKey], references: [key])

  @@unique([tenantId, toolKey])
}

model Invite {
  id         String   @id
  tenantId   String
  email      String
  roleKey    String
  token      String   @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  role   Role   @relation(fields: [roleKey], references: [key])
}

model AuditLog {
  id          String   @id
  tenantId    String?
  actorUserId String
  action      String
  entity      String
  entityId    String
  metadataJson Json?
  createdAt   DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  actor  User    @relation("AuditActor", fields: [actorUserId], references: [id])
}

model Task {
  id            String     @id
  tenantId      String
  title         String
  status        TaskStatus
  assigneeUserId String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  tenant   Tenant @relation(fields: [tenantId], references: [id])
  assignee User?  @relation("TaskAssignee", fields: [assigneeUserId], references: [id])
}

model FileItem {
  id         String   @id
  tenantId   String
  name       String
  contentText String
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model RequestItem {
  id              String        @id
  tenantId        String
  title           String
  description     String
  status          RequestStatus
  createdByUserId String
  decidedByUserId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  tenant       Tenant @relation(fields: [tenantId], references: [id])
  createdBy    User   @relation("RequestCreatedBy", fields: [createdByUserId], references: [id])
  decidedBy    User?  @relation("RequestDecidedBy", fields: [decidedByUserId], references: [id])
}
